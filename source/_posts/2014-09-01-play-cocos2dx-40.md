---
title: "【玩转cocos2d-x之四十】Cocos2d-x 3.0截屏功能集成"
date: 2014-09-01 17:18:14
comments: true
categories: cocos2d-x
tags: [截屏, 截图]
---

3.0的截屏和2.x的截屏基本上相同，都是利用RenderTexture来处理，在渲染之前调用call函数，然后调用Cocos的场景visit函数对其进行渲染，渲染结束后调用end函数即可。只是3.0截屏需要在截完屏的下一帧才能处理RenderTexture，这点要注意。关于2.x的RenderTexture的API和demo可以参见[http://blog.csdn.net/jackystudio/article/details/15498083](http://blog.csdn.net/jackystudio/article/details/15498083)。

本文的重点在于如何将截图功能继承到Cocos2d-x 3.0引擎。

<!-- more -->

<div align="center"><img src="http://img.blog.csdn.net/20140417212334312?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvamFja3lzdHVkaW8=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" border="0" title="CCAction" /><br></br></div>

### 集成到Director
这里选择把截屏功能继承到Director中，让全局的导演来执行截屏功能是一个很好的主意。

``` cpp
void Director::saveScreenshot(const std::string& fileName,const std::function<void(const std::string&)>& callback)  
{  
    Image::Format format;  
    //进行后缀判断  
    if(std::string::npos != fileName.find_last_of(".")){  
        auto extension = fileName.substr(fileName.find_last_of("."),fileName.length());  
        if (!extension.compare(".png")) {  
            format = Image::Format::PNG;  
        } else if(!extension.compare(".jpg")) {  
            format = Image::Format::JPG;  
        } else{  
            CCLOG("cocos2d: the image can only be saved as JPG or PNG format");  
            return;  
        }  
    } else {  
        CCLOG("cocos2d: the image can only be saved as JPG or PNG format");  
        return ;  
    }  
   //获取屏幕尺寸，初始化一个空的渲染纹理对象  
    auto renderTexture = RenderTexture::create(getWinSize().width, getWinSize().height, Texture2D::PixelFormat::RGBA8888);  
   //清空并开始获取  
    renderTexture->beginWithClear(0.0f, 0.0f, 0.0f, 0.0f);  
   //遍历场景节点对象，填充纹理到RenderTexture中  
    getRunningScene()->visit();  
   //结束获取  
    renderTexture->end();  
   //保存文件  
    renderTexture->saveToFile(fileName , format);  
   //使用schedule在下一帧中调用callback函数  
    auto fullPath = FileUtils::getInstance()->getWritablePath() + fileName;  
    auto scheduleCallback = [&,fullPath,callback](float dt){  
        callback(fullPath);  
    };  
    auto _schedule = getRunningScene()->getScheduler();  
    _schedule->schedule(scheduleCallback, this, 0.0f,0,0.0f, false, "screenshot");  
}
```

### 如何使用saveScreenshot
截屏功能使用起来也很简单，直接调用saveSecreenshot，其中第一个参数为文件名（支持png和jpg格式，不带后缀名默认为png格式），第二个参数为回调函数，你可以在回调函数中处理这个文件。

``` cpp
void ScreenshotTest::saveImage(Ref *pSender){  
    static int counter = 0;  
       
    char png[20];  
    sprintf(png, "image-%d.png", counter);  
    char jpg[20];  
    sprintf(jpg, "image-%d.jpg", counter);  
       
   //截屏后的回调函数，这里显示在左下角  
    auto callback = [&](const std::string& fullPath){  
        auto sprite = Sprite::create(fullPath);  
        CCASSERT(sprite!=nullptr, "Failed to create sprite.");  
        addChild(sprite);  
        sprite->setScale(0.3f);  
        sprite->setPosition(Point(40, 40));  
        sprite->setRotation(counter * 3);  
        CCLOG("Image saved %s", fullPath.c_str());  
    };  
       
   //调用Director的截屏功能  
    Director::getInstance()->saveScreenshot(png, callback);  
    counter++;  
}
```

### 源码下载
该功能已提交pull request到Cocos2d-x Github上了，有需求的童鞋们可以自己集成了。源码具体可以参见：[https://github.com/cocos2d/cocos2d-x/pull/5978](https://github.com/cocos2d/cocos2d-x/pull/5978)