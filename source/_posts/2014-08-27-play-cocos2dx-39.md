---
title: "【玩转cocos2d-x之三十九】NDK-STACK tool 的使用"
date: 2014-08-27 17:18:14
comments: true
categories: cocos2d-x
tags: [NDK-STACK, 崩溃, 调试]
---

很多童鞋在纠结在Cocos2d-x中安卓项目如何调试JNI部分的C++代码，在吃完2个茶叶蛋后我决定放大招。。。介绍一下如何使用NDK-STACK tool来恢复Cocos2d-x安卓错误堆栈信息。

本文翻译自：[http://www.cocos2d-x.org/forums/6/topics/46225](http://www.cocos2d-x.org/forums/6/topics/46225)

<!-- more -->

### 安卓 NDK-STACK tool
NDK-Stack 是一个非常易用的工具，它通过将信息显示到adb logcat中来辅助你分析堆栈追踪，然后用相应的值（哪篇源码的哪一行）来替代静态链接库中的地址。
在adb logcat的输出区，你可以看到类似下面的信息，但是在此之前我们必须先先对它进行解析。

```
I/DEBUG   (   31): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***  
I/DEBUG   (   31): Build fingerprint: 'generic/google_sdk/generic/:2.2/FRF91/43546:eng/test-keys'  
I/DEBUG   (   31): pid: 351, tid: 351  %gt;%gt;%gt; /data/local/ndk-tests/crasher <<<  
I/DEBUG   (   31): signal 11 (SIGSEGV), fault addr 0d9f00d8  
I/DEBUG   (   31):  r0 0000af88  r1 0000a008  r2 baadf00d  r3 0d9f00d8  
I/DEBUG   (   31):  r4 00000004  r5 0000a008  r6 0000af88  r7 00013c44  
I/DEBUG   (   31):  r8 00000000  r9 00000000  10 00000000  fp 00000000  
I/DEBUG   (   31):  ip 0000959c  sp be956cc8  lr 00008403  pc 0000841e  cpsr 60000030  
I/DEBUG   (   31):          #00  pc 0000841e  /data/local/ndk-tests/crasher  
I/DEBUG   (   31):          #01  pc 000083fe  /data/local/ndk-tests/crasher  
I/DEBUG   (   31):          #02  pc 000083f6  /data/local/ndk-tests/crasher  
I/DEBUG   (   31):          #03  pc 000191ac  /system/lib/libc.so  
I/DEBUG   (   31):          #04  pc 000083ea  /data/local/ndk-tests/crasher  
I/DEBUG   (   31):          #05  pc 00008458  /data/local/ndk-tests/crasher  
I/DEBUG   (   31):          #06  pc 0000d362  /system/lib/libc.so  
I/DEBUG   (   31):  
```

### 如何使用这个工具？
如果你成功地编译了一个Cocos2d-x安卓项目，它将会在`$PROJECT_PATH/obj/local/<abi>`目录下生产一个静态链接库，这里的<abi>代表你的设备的ABI（比如，默认为armeabi）。
你可以将输出结果作为输入，就像下面这样：

```
adb logcat | $NDK/ndk-stack -sym $PROJECT_PATH/obj/local/armeabi
```

或者你也可以使用 -dump选项将指定logcat保存为文件作为输入，就像下面这样：

```
adb logcat > /tmp/foo.txt  
$NDK/ndk-stack -sym $PROJECT_PATH/obj/local/armeabi -dump foo.txt  
```

最后，你就可以得到更多有效可读的输出信息：

```
********** Crash dump: **********  
Build fingerprint: 'generic/google_sdk/generic/:2.2/FRF91/43546:eng/test-keys'  
pid: 351, tid: 351  >>> /data/local/ndk-tests/crasher <<<  
signal 11 (SIGSEGV), fault addr 0d9f00d8  
Stack frame #00  pc 0000841e  /data/local/ndk-tests/crasher : Routine zoo in /tmp/foo/crasher/jni/zoo.c:13  
Stack frame #01  pc 000083fe  /data/local/ndk-tests/crasher : Routine bar in /tmp/foo/crasher/jni/bar.c:5  
Stack frame #02  pc 000083f6  /data/local/ndk-tests/crasher : Routine my_comparison in /tmp/foo/crasher/jni/foo.c:9  
Stack frame #03  pc 000191ac  /system/lib/libc.so  
Stack frame #04  pc 000083ea  /data/local/ndk-tests/crasher : Routine foo in /tmp/foo/crasher/jni/foo.c:14  
Stack frame #05  pc 00008458  /data/local/ndk-tests/crasher : Routine main in /tmp/foo/crasher/jni/main.c:19  
Stack frame #06  pc 0000d362  /system/lib/libc.so
```

### 重要提示
NDK-STACK tool的logcat输出需要有一个初始化行，比如像下面这样：

```
*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
```

当复制/粘帖追踪信息时，不要忘记把这个初始化行也给带上，否则NDK-STACK tool将不会正常的工作。
目前对各平台（linux/windows/mac）的NDK（可见[Android Developer](http://developer.android.com/tools/sdk/ndk/index.html)），NDK-STACK都是有效的。

### 参考文档
$NDK_ROOT/docs/NDK-STACK.html
